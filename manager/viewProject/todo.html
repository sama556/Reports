<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StratAnalytica | KPI Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../../css/comman.css"/>
    <link rel="stylesheet" href="../../css/todo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="#" class="logo">
                <i class="fas fa-chart-network"></i>
                <span>StratAnalytica</span>
            </a>
            <nav>
                <ul>
                    <li><a href="../view-projects.html"><i class="fas fa-arrow-left"></i> Back</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="dashboard">
        <aside class="sidebar">
            <div class="project-info">
                <h2 id="projectName">Project Name</h2>
                <span class="project-status" id="projectStatus">Active</span>
                
                <div class="project-meta">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="projectDates">Jan 1, 2023 - Dec 31, 2023</span>
                </div>
                <div class="project-meta">
                    <i class="fas fa-user"></i>
                    <span id="projectCreator">Created by: John Doe</span>
                </div>
                <div class="project-meta">
                    <i class="fas fa-chart-pie"></i>
                    <span id="projectProgress">Progress: 65%</span>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="../../manager/viewProject/project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="../../manager/viewProject/risks.html"><i class="fas fa-exclamation-triangle"></i> Risks</a></li>
                <li><a href="../../manager/viewProject/kpis.html" id="kpisLink"><i class="fas fa-bullseye"></i> KPIs</a></li>
                <li><a href="../../manager/viewProject/Sales-Performance.html" ><i class="fas fa-chart-line"></i> Sales Performance</a></li>
                <li><a href="../../manager/viewProject/feedback.html"><i class="fas fa-comment"></i> Feedback</a></li>
                <li><a href="../../manager/viewProject/todo.html" class="active"><i class="fas fa-tasks"></i> To-do List</a></li>
                <li><a href="../../manager/viewProject/budget.html"><i class="fas fa-wallet"></i> Budget</a></li>
                <li><a href="../../manager/viewProject/notifications.html"><i class="fas fa-bell"></i> Notifications</a></li>
                <li><a href="../../manager/viewProject/reports.html"><i class="fas fa-file-export"></i> Reports</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="card">
                <div class="container">
                    <div class="kanban-header">
                        <h1>To do LIST </h1>
                        <button class="add-btn" id="addTaskBtn"><i class="fas fa-plus"></i> Add New Task</button>
                    </div>
                    
                    <div class="kanban-board" id="kanbanBoard">
                        <!-- To Do Column -->
                        <div class="kanban-column todo" id="todoColumn">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-clipboard-list"></i>
                                    To Do
                                    <span class="column-count" id="todoCount">0</span>
                                </div>
                            </div>
                            <div class="task-list" id="todoList">
                                <!-- Task cards will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- In Progress Column -->
                        <div class="kanban-column in-progress" id="inProgressColumn">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-spinner"></i>
                                    In Progress
                                    <span class="column-count" id="inProgressCount">0</span>
                                </div>
                            </div>
                            <div class="task-list" id="inProgressList">
                                <!-- Task cards will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Done Column -->
                        <div class="kanban-column done" id="doneColumn">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-check-circle"></i>
                                    Done
                                    <span class="column-count" id="doneCount">0</span>
                                </div>
                            </div>
                            <div class="task-list" id="doneList">
                                <!-- Task cards will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Task Form -->
                    <div class="task-form-container" id="newTaskForm" style="display: none;">
                        <div class="form-title">
                            <i class="fas fa-plus-circle"></i>
                            <h2>Add New Task</h2>
                        </div>
                        <form class="task-form" id="taskForm">
                            <div class="form-group">
                                <label for="taskDescription">Task Description</label>
                                <textarea id="taskDescription" placeholder="Describe the task..." required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="assignedTo">Assign To</label>
                                <select id="assignedTo" required>
                                    <option value="">Select team member</option>
                                    <option value="Sami Alharbi">Sami Alharbi</option>
                                    <option value="Layla Mahmoud">Layla Mahmoud</option>
                                    <option value="Nasser Faisal">Nasser Faisal</option>
                                    <option value="Omar Khalid">Omar Khalid</option>
                                    <option value="Amira Hassan">Amira Hassan</option>
                                    <option value="Khalid Rahman">Khalid Rahman</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dueDate">Due Date</label>
                                <input type="text" id="dueDate" placeholder="Select due date" required>
                            </div>
                            <div class="form-group">
                                <label for="taskPriority">Priority</label>
                                <select id="taskPriority" required>
                                    <option value="">Select priority</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="initialNotes">Initial Notes</label>
                                <textarea id="initialNotes" placeholder="Add any initial notes..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <button type="submit" class="submit-btn">Create Task</button>
                            </div>
                        </form>
                    </div>
                </div>
                
            </div>
        </main>
    </div>
    <script>
        // Task data - in a real app this would come from an API
        let tasks = [
            {
                id: 1,
                description: "Design new homepage layout",
                assignedTo: "Sami Alharbi",
                dueDate: "2023-05-15",
                priority: "high",
                status: "todo",
                progress: 0,
                notes: [
                    "Need to align with brand guidelines",
                    "Client wants modern look"
                ]
            },
            {
                id: 2,
                description: "Implement user authentication",
                assignedTo: "Omar Khalid",
                dueDate: "2023-05-10",
                priority: "medium",
                status: "in-progress",
                progress: 65,
                notes: [
                    "OAuth integration needed",
                    "Password reset flow pending"
                ]
            },
            {
                id: 3,
                description: "Write API documentation",
                assignedTo: "Layla Mahmoud",
                dueDate: "2023-05-05",
                priority: "low",
                status: "done",
                progress: 100,
                notes: [
                    "Documented all endpoints",
                    "Added example requests"
                ]
            },
            {
                id: 4,
                description: "Fix mobile menu bug",
                assignedTo: "Amira Hassan",
                dueDate: "2023-05-08",
                priority: "high",
                status: "todo",
                progress: 0,
                notes: [
                    "Reported by multiple users",
                    "Affects iOS devices"
                ]
            },
            {
                id: 5,
                description: "Optimize database queries",
                assignedTo: "Nasser Faisal",
                dueDate: "2023-05-12",
                priority: "medium",
                status: "in-progress",
                progress: 30,
                notes: [
                    "Identified slow queries",
                    "Indexing in progress"
                ]
            }
        ];

        // DOM Elements
        const kanbanBoard = document.getElementById('kanbanBoard');
        const todoList = document.getElementById('todoList');
        const inProgressList = document.getElementById('inProgressList');
        const doneList = document.getElementById('doneList');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const newTaskForm = document.getElementById('newTaskForm');
        const taskForm = document.getElementById('taskForm');
        const todoCount = document.getElementById('todoCount');
        const inProgressCount = document.getElementById('inProgressCount');
        const doneCount = document.getElementById('doneCount');

        // Initialize date picker
        flatpickr("#dueDate", {
            minDate: "today",
            dateFormat: "Y-m-d"
        });

        // Render tasks on the board
        function renderTasks() {
            // Clear all lists
            todoList.innerHTML = '';
            inProgressList.innerHTML = '';
            doneList.innerHTML = '';
            
            // Filter tasks by status
            const todoTasks = tasks.filter(task => task.status === 'todo');
            const inProgressTasks = tasks.filter(task => task.status === 'in-progress');
            const doneTasks = tasks.filter(task => task.status === 'done');
            
            // Update counts
            todoCount.textContent = todoTasks.length;
            inProgressCount.textContent = inProgressTasks.length;
            doneCount.textContent = doneTasks.length;
            
            // Render todo tasks
            todoTasks.forEach(task => {
                todoList.appendChild(createTaskCard(task));
            });
            
            // Render in-progress tasks
            inProgressTasks.forEach(task => {
                inProgressList.appendChild(createTaskCard(task));
            });
            
            // Render done tasks
            doneTasks.forEach(task => {
                doneList.appendChild(createTaskCard(task));
            });
            
            // Add event listeners to all buttons
            addTaskButtonListeners();
        }

        // Create a task card element
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card priority-${task.priority}`;
            card.dataset.id = task.id;
            card.draggable = true;
            
            // Check if task is overdue
            const today = new Date();
            const dueDate = new Date(task.dueDate);
            const isOverdue = dueDate < today && task.status !== 'done';
            
            // Format due date
            const formattedDate = dueDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            card.innerHTML = `
                <div class="task-meta">
                    <span class="task-id">#${task.id}</span>
                    <span class="task-priority priority-${task.priority}">${task.priority}</span>
                </div>
                <div class="task-description">
                    ${task.description}
                </div>
                <div class="task-due-date ${isOverdue ? 'overdue' : ''}">
                    <i class="fas fa-calendar-day"></i>
                    Due: ${formattedDate} ${isOverdue ? '(Overdue)' : ''}
                </div>
                <div class="task-assigned">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(task.assignedTo)}&background=random" alt="${task.assignedTo}">
                    <span>${task.assignedTo}</span>
                </div>
                ${task.status !== 'done' ? `
                <div class="task-progress">
                    <div class="progress-header">
                        <span>Progress</span>
                        <span>${task.progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${task.progress}%"></div>
                    </div>
                </div>
                ` : ''}
                <div class="task-actions">
                    ${task.status !== 'done' ? `
                    <button class="task-btn update-progress-btn" data-id="${task.id}">
                        <i class="fas fa-tasks"></i> Update Progress
                    </button>
                    ` : ''}
                    ${task.status !== 'done' ? `
                    <button class="task-btn complete-btn" data-id="${task.id}">
                        <i class="fas fa-check"></i> Mark Complete
                    </button>
                    ` : ''}
                    <button class="task-btn add-note-btn" data-id="${task.id}">
                        <i class="fas fa-plus-circle"></i> ${task.notes.length > 0 ? `Notes (${task.notes.length})` : 'Add Note'}
                    </button>
                </div>
            `;
            
            return card;
        }

        // Add event listeners to all task buttons
        function addTaskButtonListeners() {
            // Update progress buttons
            document.querySelectorAll('.update-progress-btn').forEach(btn => {
                btn.addEventListener('click', handleUpdateProgress);
            });
            
            // Complete task buttons
            document.querySelectorAll('.complete-btn').forEach(btn => {
                btn.addEventListener('click', handleCompleteTask);
            });
            
            // Add note buttons
            document.querySelectorAll('.add-note-btn').forEach(btn => {
                btn.addEventListener('click', handleAddNote);
            });
            
            // Add drag events to cards
            document.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        // Handle update progress button click
        function handleUpdateProgress(e) {
            const taskId = parseInt(e.currentTarget.dataset.id);
            const task = tasks.find(t => t.id === taskId);
            
            Swal.fire({
                title: 'Update Task Progress',
                html: `
                    <div style="text-align: left; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Progress Percentage</label>
                        <input type="range" id="progressSlider" min="0" max="100" value="${task.progress}" 
                               style="width: 100%; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>0%</span>
                            <span id="progressValue">${task.progress}%</span>
                            <span>100%</span>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Update',
                confirmButtonColor: '#4a6bdf',
                didOpen: () => {
                    const slider = document.getElementById('progressSlider');
                    const valueDisplay = document.getElementById('progressValue');
                    
                    slider.addEventListener('input', () => {
                        valueDisplay.textContent = `${slider.value}%`;
                    });
                },
                preConfirm: () => {
                    return {
                        progress: parseInt(document.getElementById('progressSlider').value)
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    task.progress = result.value.progress;
                    
                    // If progress is 100%, move to done column
                    if (task.progress === 100) {
                        task.status = 'done';
                    }
                    // If progress > 0, move to in-progress if not already
                    else if (task.progress > 0 && task.status === 'todo') {
                        task.status = 'in-progress';
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Progress Updated',
                        text: `Task progress is now ${task.progress}%`,
                        confirmButtonColor: '#4a6bdf'
                    }).then(() => {
                        renderTasks();
                    });
                }
            });
        }

        // Handle complete task button click
        function handleCompleteTask(e) {
            const taskId = parseInt(e.currentTarget.dataset.id);
            const task = tasks.find(t => t.id === taskId);
            
            Swal.fire({
                title: 'Mark Task as Complete?',
                text: "This will move the task to the Done column.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6bd968',
                cancelButtonColor: '#ff5b5b',
                confirmButtonText: 'Yes, complete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    task.status = 'done';
                    task.progress = 100;
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Task Completed',
                        text: 'The task has been marked as done.',
                        confirmButtonColor: '#4a6bdf'
                    }).then(() => {
                        renderTasks();
                    });
                }
            });
        }

        // Handle add note button click
        function handleAddNote(e) {
            const taskId = parseInt(e.currentTarget.dataset.id);
            const task = tasks.find(t => t.id === taskId);
            
            // Show existing notes if any
            let notesHtml = '';
            if (task.notes.length > 0) {
                notesHtml = `
                    <div style="text-align: left; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">Existing Notes:</h4>
                        <ul style="list-style-type: none; padding-left: 0;">
                            ${task.notes.map(note => `<li style="margin-bottom: 5px; padding: 8px; background: #f5f7fa; border-radius: 4px;">${note}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            Swal.fire({
                title: 'Add Note to Task',
                html: `${notesHtml}
                    <div style="text-align: left;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">New Note</label>
                        <textarea id="swalNote" style="width: 100%; min-height: 100px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Add Note',
                confirmButtonColor: '#4a6bdf',
                focusConfirm: false,
                preConfirm: () => {
                    const note = document.getElementById('swalNote').value.trim();
                    if (!note) {
                        Swal.showValidationMessage('Please enter a note');
                        return false;
                    }
                    return note;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    task.notes.push(result.value);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Note Added',
                        text: 'Your note has been added to this task.',
                        confirmButtonColor: '#4a6bdf'
                    }).then(() => {
                        renderTasks();
                    });
                }
            });
        }

        // Handle form submission
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newTask = {
                id: tasks.length > 0 ? Math.max(...tasks.map(task => task.id)) + 1 : 1,
                description: document.getElementById('taskDescription').value,
                assignedTo: document.getElementById('assignedTo').value,
                dueDate: document.getElementById('dueDate').value,
                priority: document.getElementById('taskPriority').value,
                status: 'todo',
                progress: 0,
                notes: document.getElementById('initialNotes').value ? 
                    [document.getElementById('initialNotes').value] : []
            };
            
            tasks.unshift(newTask);
            
            Swal.fire({
                icon: 'success',
                title: 'Task Created',
                text: 'The new task has been added to your board.',
                confirmButtonColor: '#4a6bdf'
            }).then(() => {
                // Reset form and hide it
                taskForm.reset();
                document.getElementById('dueDate').value = '';
                newTaskForm.style.display = 'none';
                addTaskBtn.innerHTML = '<i class="fas fa-plus"></i> Add New Task';
                
                // Refresh the view
                renderTasks();
            });
        });

        // Drag and drop functionality
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            draggedItem = null;
        }

        // Add event listeners to all columns
        document.querySelectorAll('.task-list').forEach(list => {
            list.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(this, e.clientY);
                if (draggedItem) {
                    if (afterElement) {
                        this.insertBefore(draggedItem, afterElement);
                    } else {
                        this.appendChild(draggedItem);
                    }
                }
            });
            
            list.addEventListener('drop', function(e) {
                e.preventDefault();
                const taskId = parseInt(draggedItem.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                
                // Determine new status based on column
                let newStatus = 'todo';
                if (this.id === 'inProgressList') {
                    newStatus = 'in-progress';
                } else if (this.id === 'doneList') {
                    newStatus = 'done';
                }
                
                // Update task status and progress if needed
                if (newStatus === 'done') {
                    task.progress = 100;
                } else if (newStatus === 'in-progress' && task.progress === 0) {
                    task.progress = 10; // Default progress when moved to in-progress
                }
                
                task.status = newStatus;
                
                // Re-render to update counts and positions
                renderTasks();
            });
        });

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Toggle the new task form
        addTaskBtn.addEventListener('click', function() {
            if (newTaskForm.style.display === 'none') {
                newTaskForm.style.display = 'block';
                this.innerHTML = '<i class="fas fa-times"></i> Cancel';
            } else {
                newTaskForm.style.display = 'none';
                this.innerHTML = '<i class="fas fa-plus"></i> Add New Task';
            }
        });

        // Initial render
        renderTasks();
    </script>
</body>
</html>