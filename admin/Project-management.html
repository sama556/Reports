<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management | StratAnalytica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/comman.css"/>
    <link rel="stylesheet" href="../css/project-management.css"/>
</head>
<body>
    <header class="header">
        <div class="container header-container">
            <a href="#" class="logo">
                <i class="fas fa-chart-network"></i>
                <span>StratAnalytica</span>
            </a>
            <nav>
                <ul>
                    <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
                    <li><a href="update-profile.html"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="../langingPage.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="dashboard">
        <!-- Admin Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><span class="badge badge-admin">Admin</span></li>
                <li><a href="#"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="user-mangement.html"><i class="fas fa-users"></i> <span>User Management</span></a></li>
                <li><a href="Project-management.html" class="active"><i class="fas fa-project-diagram"></i> <span>Project Management</span></a></li>
                <li><a href="view-projects.html"><i class="fas fa-chart-line"></i> <span>View Projects</span></a></li>
            </ul>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Project Management</h2>
                    <button id="addProjectBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Project
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Description</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- Projects will be loaded here via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Sample user data from your database (managers and analysts)
        const users = [
            { User_ID: 1, Username: "johndoe", Email: "john@example.com", Role: "manager", Name: "John Doe" },
            { User_ID: 2, Username: "janesmith", Email: "jane@example.com", Role: "manager", Name: "Jane Smith" },
            { User_ID: 3, Username: "mikej", Email: "mike@example.com", Role: "analyst", Name: "Mike Johnson" },
            { User_ID: 4, Username: "sarahw", Email: "sarah@example.com", Role: "analyst", Name: "Sarah Williams" }
        ];

        // Sample project data with proper Created_By references to User_ID
        let projects = [
            {
                Project_ID: 1,
                Project_Name: "Website Redesign",
                Description: "Complete redesign of company website with modern UI/UX",
                Start_Date: "2023-05-01",
                End_Date: "2023-07-15",
                Status: "completed",
                Created_By: 1, // References User_ID 1 (John Doe)
                Last_Updated: "2023-07-10T14:30:00Z"
            },
            {
                Project_ID: 2,
                Project_Name: "Mobile App Development",
                Description: "Development of cross-platform mobile application",
                Start_Date: "2023-06-10",
                End_Date: "2023-09-30",
                Status: "active",
                Created_By: 2, // References User_ID 2 (Jane Smith)
                Last_Updated: "2023-08-15T10:45:00Z"
            },
            {
                Project_ID: 3,
                Project_Name: "CRM Implementation",
                Description: "Implementation of new CRM system for sales team",
                Start_Date: "2023-07-15",
                End_Date: "2023-10-20",
                Status: "pending",
                Created_By: 3, // References User_ID 3 (Mike Johnson)
                Last_Updated: "2023-07-20T16:20:00Z"
            }
        ];

        // DOM elements
        const projectsTableBody = document.getElementById('projectsTableBody');
        const addProjectBtn = document.getElementById('addProjectBtn');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            renderProjects();
            addProjectBtn.addEventListener('click', showAddProjectModal);
        });

        // Render projects to the table
        function renderProjects() {
            projectsTableBody.innerHTML = '';
            
            if (projects.length === 0) {
                projectsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No projects found</td></tr>';
                return;
            }
            
            projects.forEach(project => {
                const row = document.createElement('tr');
                
                // Determine status class
                let statusClass = '';
                switch (project.Status) {
                    case 'active': statusClass = 'status-active'; break;
                    case 'completed': statusClass = 'status-completed'; break;
                    case 'pending': statusClass = 'status-pending'; break;
                    case 'cancelled': statusClass = 'status-cancelled'; break;
                }
                
                // Find the creator user
                const creator = users.find(u => u.User_ID === project.Created_By);
                const creatorName = creator ? creator.Name : 'Unknown User';
                
                row.innerHTML = `
                    <td>${project.Project_Name}</td>
                    <td>${project.Description}</td>
                    <td>${formatDate(project.Start_Date)}</td>
                    <td>${formatDate(project.End_Date)}</td>
                    <td><span class="status ${statusClass}">${capitalizeFirstLetter(project.Status)}</span></td>
                    <td>${creatorName}</td>
                    <td>${formatDateTime(project.Last_Updated)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-success edit-btn" data-id="${project.Project_ID}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-info view-btn" data-id="${project.Project_ID}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger delete-btn" data-id="${project.Project_ID}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                projectsTableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => showEditProjectModal(e.target.dataset.id));
            });
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => showViewProjectModal(e.target.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => confirmDeleteProject(e.target.dataset.id));
            });
        }

        // Show add project modal
        function showAddProjectModal() {
            // Get only managers for the Created By dropdown
            const managers = users.filter(u => u.Role === 'manager');
            
            Swal.fire({
                title: 'Add New Project',
                html: `
                    <form id="projectForm">
                        <div class="swal2-input-container">
                            <label>Project Name</label>
                            <input type="text" id="projectName" class="swal2-input" placeholder="Project Name" required>
                        </div>
                        <div class="swal2-input-container">
                            <label>Description</label>
                            <textarea id="projectDescription" class="swal2-input" placeholder="Project Description" rows="3" required></textarea>
                        </div>
                        <div class="swal2-input-container">
                            <label>Start Date</label>
                            <input type="date" id="startDate" class="swal2-input" required>
                        </div>
                        <div class="swal2-input-container">
                            <label>End Date</label>
                            <input type="date" id="endDate" class="swal2-input" required>
                        </div>
                        <div class="swal2-input-container">
                            <label>Status</label>
                            <select id="status" class="swal2-input" required>
                                <option value="">Select Status</option>
                                <option value="active">Active</option>
                            
                            </select>
                        </div>
                        <div class="swal2-input-container">
                            <label>Created By (Manager)</label>
                            <select id="createdBy" class="swal2-input" required>
                                <option value="">Select Manager</option>
                                ${managers.map(user => 
                                    `<option value="${user.User_ID}">${user.Name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </form>
                `,
                focusConfirm: false,
                confirmButtonText: 'Add Project',
                showCancelButton: true,
                width: '700px',
                preConfirm: () => {
                    const name = document.getElementById('projectName').value;
                    const description = document.getElementById('projectDescription').value;
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    const status = document.getElementById('status').value;
                    const createdBy = document.getElementById('createdBy').value;
                    
                    if (!name || !description || !startDate || !endDate || !status || !createdBy) {
                        Swal.showValidationMessage('Please fill in all fields');
                        return false;
                    }
                    
                    if (new Date(endDate) < new Date(startDate)) {
                        Swal.showValidationMessage('End date must be after start date');
                        return false;
                    }
                    
                    return { 
                        Project_Name: name,
                        Description: description,
                        Start_Date: startDate,
                        End_Date: endDate,
                        Status: status,
                        Created_By: parseInt(createdBy)
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newProject = {
                        Project_ID: projects.length > 0 ? Math.max(...projects.map(p => p.Project_ID)) + 1 : 1,
                        ...result.value,
                        Last_Updated: new Date().toISOString()
                    };
                    
                    projects.unshift(newProject);
                    renderProjects();
                    
                    Swal.fire(
                        'Success!',
                        'Project has been added.',
                        'success'
                    );
                }
            });
        }

        document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        // Get the closest button if clicking on an icon inside the button
        const button = e.target.closest('.edit-btn');
        const projectId = button.getAttribute('data-id');
        showEditProjectModal(projectId);
    });
});

document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        // Get the closest button if clicking on an icon inside the button
        const button = e.target.closest('.view-btn');
        const projectId = button.getAttribute('data-id');
        showViewProjectModal(projectId);
    });
});

document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        // Get the closest button if clicking on an icon inside the button
        const button = e.target.closest('.delete-btn');
        const projectId = button.getAttribute('data-id');
        confirmDeleteProject(projectId);
    });
});

// Fix the showViewProjectModal function to handle potential undefined projects
function showViewProjectModal(projectId) {
    const project = projects.find(p => p.Project_ID === parseInt(projectId));
    
    if (!project) {
        Swal.fire({
            title: 'Error',
            text: 'Project not found!',
            icon: 'error',
            confirmButtonText: 'Close'
        });
        return;
    }
    
    const creator = users.find(u => u.User_ID === project.Created_By);
    
    let statusClass = '';
    switch (project.Status) {
        case 'active': statusClass = 'status-active'; break;
        case 'completed': statusClass = 'status-completed'; break;
        case 'pending': statusClass = 'status-pending'; break;
        case 'cancelled': statusClass = 'status-cancelled'; break;
    }
    
    Swal.fire({
        title: project.Project_Name,
        html: `
            <div style="text-align: left;">
                <div style="margin-bottom: 20px;">
                    <p><strong>Description:</strong> ${project.Description}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>Start Date:</strong> ${formatDate(project.Start_Date)}</p>
                        <p><strong>End Date:</strong> ${formatDate(project.End_Date)}</p>
                        <p><strong>Status:</strong> <span class="status ${statusClass}">${capitalizeFirstLetter(project.Status)}</span></p>
                    </div>
                    <div>
                        <p><strong>Created By:</strong> ${creator ? creator.Name : 'Unknown'} (${creator ? creator.Role : 'Unknown'})</p>
                        <p><strong>Email:</strong> ${creator ? creator.Email : 'N/A'}</p>
                        <p><strong>Last Updated:</strong> ${formatDateTime(project.Last_Updated)}</p>
                        <p><strong>Project ID:</strong> ${project.Project_ID}</p>
                    </div>
                </div>
            </div>
        `,
        confirmButtonText: 'Close',
        width: '700px'
    });
}

// Fix the showEditProjectModal function to handle potential undefined projects
function showEditProjectModal(projectId) {
    const project = projects.find(p => p.Project_ID === parseInt(projectId));
    
    if (!project) {
        Swal.fire({
            title: 'Error',
            text: 'Project not found!',
            icon: 'error',
            confirmButtonText: 'Close'
        });
        return;
    }
    
    const managers = users.filter(u => u.Role === 'manager');
    
    Swal.fire({
        title: 'Edit Project',
        html: `
            <form id="projectForm">
                <div class="swal2-input-container">
                    <label>Project Name</label>
                    <input type="text" id="projectName" class="swal2-input" value="${project.Project_Name}" required>
                </div>
                <div class="swal2-input-container">
                    <label>Description</label>
                    <textarea id="projectDescription" class="swal2-input" rows="3" required>${project.Description}</textarea>
                </div>
                <div class="swal2-input-container">
                    <label>Start Date</label>
                    <input type="date" id="startDate" class="swal2-input" value="${project.Start_Date}" required>
                </div>
                <div class="swal2-input-container">
                    <label>End Date</label>
                    <input type="date" id="endDate" class="swal2-input" value="${project.End_Date}" required>
                </div>
                <div class="swal2-input-container">
                    <label>Status</label>
                    <select id="status" class="swal2-input" required>
                        <option value="active" ${project.Status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="pending" ${project.Status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="completed" ${project.Status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="cancelled" ${project.Status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                </div>
                <div class="swal2-input-container">
                    <label>Created By (Manager)</label>
                    <select id="createdBy" class="swal2-input" required>
                        ${managers.map(user => 
                            `<option value="${user.User_ID}" ${project.Created_By === user.User_ID ? 'selected' : ''}>
                                ${user.Name}
                            </option>`
                        ).join('')}
                    </select>
                </div>
            </form>
        `,
        focusConfirm: false,
        confirmButtonText: 'Save Changes',
        showCancelButton: true,
        width: '700px',
        preConfirm: () => {
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDescription').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const status = document.getElementById('status').value;
            const createdBy = document.getElementById('createdBy').value;
            
            if (!name || !description || !startDate || !endDate || !status || !createdBy) {
                Swal.showValidationMessage('Please fill in all fields');
                return false;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                Swal.showValidationMessage('End date must be after start date');
                return false;
            }
            
            return { 
                Project_Name: name,
                Description: description,
                Start_Date: startDate,
                End_Date: endDate,
                Status: status,
                Created_By: parseInt(createdBy)
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const updatedProject = {
                ...project,
                ...result.value,
                Last_Updated: new Date().toISOString()
            };
            
            const index = projects.findIndex(p => p.Project_ID === project.Project_ID);
            if (index !== -1) {
                projects[index] = updatedProject;
                renderProjects();
                
                Swal.fire(
                    'Success!',
                    'Project has been updated.',
                    'success'
                );
            }
        }
    });
}

// Fix the confirmDeleteProject function to handle potential undefined projects
function confirmDeleteProject(projectId) {
    const project = projects.find(p => p.Project_ID === parseInt(projectId));
    
    if (!project) {
        Swal.fire({
            title: 'Error',
            text: 'Project not found!',
            icon: 'error',
            confirmButtonText: 'Close'
        });
        return;
    }
    
    Swal.fire({
        title: 'Delete Project?',
        html: `Are you sure you want to delete <strong>${project.Project_Name}</strong> (ID: ${project.Project_ID})?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            projects = projects.filter(p => p.Project_ID !== parseInt(projectId));
            renderProjects();
            
            Swal.fire(
                'Deleted!',
                'Project has been deleted.',
                'success'
            );
        }
    });
}

// Fix the renderProjects function to correctly add event listeners
function renderProjects() {
    projectsTableBody.innerHTML = '';
    
    if (projects.length === 0) {
        projectsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No projects found</td></tr>';
        return;
    }
    
    projects.forEach(project => {
        const row = document.createElement('tr');
        
        // Determine status class
        let statusClass = '';
        switch (project.Status) {
            case 'active': statusClass = 'status-active'; break;
            case 'completed': statusClass = 'status-completed'; break;
            case 'pending': statusClass = 'status-pending'; break;
            case 'cancelled': statusClass = 'status-cancelled'; break;
        }
        
        // Find the creator user
        const creator = users.find(u => u.User_ID === project.Created_By);
        const creatorName = creator ? creator.Name : 'Unknown User';
        
        row.innerHTML = `
            <td>${project.Project_Name}</td>
            <td>${project.Description}</td>
            <td>${formatDate(project.Start_Date)}</td>
            <td>${formatDate(project.End_Date)}</td>
            <td><span class="status ${statusClass}">${capitalizeFirstLetter(project.Status)}</span></td>
            <td>${creatorName}</td>
            <td>${formatDateTime(project.Last_Updated)}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-success edit-btn" data-id="${project.Project_ID}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-info view-btn" data-id="${project.Project_ID}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-danger delete-btn" data-id="${project.Project_ID}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        projectsTableBody.appendChild(row);
    });
    
    // Add event listeners to buttons with improved event delegation
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const button = e.target.closest('.edit-btn');
            if (button) {
                const projectId = button.getAttribute('data-id');
                showEditProjectModal(projectId);
            }
        });
    });
    
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const button = e.target.closest('.view-btn');
            if (button) {
                const projectId = button.getAttribute('data-id');
                showViewProjectModal(projectId);
            }
        });
    });
    
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const button = e.target.closest('.delete-btn');
            if (button) {
                const projectId = button.getAttribute('data-id');
                confirmDeleteProject(projectId);
            }
        });
    });
}
        // Helper functions
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        function formatDateTime(dateTimeString) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateTimeString).toLocaleString(undefined, options);
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>